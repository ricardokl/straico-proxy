{%- if tools %}
  {{- '<|im_start|>system\\n' }}
  {%- if messages[0].role == 'system' %}
    {{- messages[0].content + '\\n\\n' }}
  {%- endif %}
  {{- \"# Tools\\n\\nYou may call one or more functions to assist with the user query.\\n\\nYou are provided with function signatures within <tools></tools> XML tags:\\n<tools>\" }}
  {%- for tool in tools %}
    {{- \"\\n\" }}
    {{- tool | tojson }}
  {%- endfor %}
  {{- \"\\n</tools>\\n\\nFor each function call, return a json object with function name and arguments within <tool_call></tool_call> XML tags:\\n<tool_call>\\n{\\\"name\\\": <function-name>, \\\"arguments\\\": <args-json-object>}\\n</tool_call><|im_end|>\\n\" }}
{%- else %}
  {%- if messages[0].role == 'system' %}
    {{- '<|im_start|>system\\n' + messages[0].content + '<|im_end|>\\n' }}
  {%- endif %}
{%- endif %}
{%- for message in messages %}
  {%- if message.content is string %}
    {%- set content = message.content %}
  {%- else %}
    {%- set content = '' %}
  {%- endif %}
  {%- if (message.role == \"user\") or (message.role == \"system\" and not loop.first) %}
    {{- '<|im_start|>' + message.role + '\\n' + content + '<|im_end|>' + '\\n' }}
  {%- elif message.role == \"assistant\" %}
    {{- '<|im_start|>' + message.role + '\\n' + content }}
    {%- if message.tool_calls %}
      {%- for tool_call in message.tool_calls %}
        {%- if (loop.first and content) or (not loop.first) %}
          {{- '\\n' }}
        {%- endif %}
        {%- if tool_call.function %}
          {%- set tool_call = tool_call.function %}
        {%- endif %}\n                {{- '<tool_call>\\n{\"name\": \"' }}\n                {{- tool_call.name }}\n                {{- '\", \"arguments\": ' }}\n                {%- if tool_call.arguments is string %}\n                    {{- tool_call.arguments }}\n                {%- else %}\n                    {{- tool_call.arguments | tojson }}\n                {%- endif %}\n                {{- '}\\n</tool_call>' }}\n            {%- endfor %}\n        {%- endif %}\n        {{- '<|im_end|>\\n' }}\n    {%- elif message.role == \"tool\" %}\n        {%- if loop.first or (messages[loop.index0 - 1].role != \"tool\") %}\n            {{- '<|im_start|>user' }}\n        {%- endif %}\n        {{- '\\n<tool_response>\\n' }}\n        {{- content }}\n        {{- '\\n</tool_response>' }}\n        {%- if loop.last or (messages[loop.index0 + 1].role != \"tool\") %}\n            {{- '<|im_end|>\\n' }}\n        {%- endif %}\n    {%- endif %}\n{%- endfor %}\n{%- if add_generation_prompt %}\n    {{- '<|im_start|>assistant\\n' }}\n{%- endif %}
 
